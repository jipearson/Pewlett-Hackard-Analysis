-- DELIVERABLE 1

-- CREATE RETIREMENT_TITLES DATASET 
SELECT 
E.EMP_NO
,E.FIRST_NAME
,E.LAST_NAME
,T.TITLE
,T.FROM_DATE
,T.TO_DATE
INTO EMP_TITLES
FROM EMPLOYEES AS E
INNER JOIN TITLES T ON (E.EMP_NO = T.EMP_NO)
WHERE (E.BIRTH_DATE BETWEEN '1952-01-01' AND '1955-12-31')
ORDER BY EMP_NO
;

SELECT *
FROM EMP_TITLES;

DROP TABLE EMP_TITLES;

-- USE DICTINCT WITH ORDERBY TO REMOVE DUPLICATE ROWS
SELECT DISTINCT ON (EMP_NO) 
EMP_NO
,FIRST_NAME
,LAST_NAME
,TITLE
INTO MOST_RECENT_TITLE
FROM EMP_TITLES
ORDER BY EMP_NO, TO_DATE DESC;

-- GET THE NUMBER OF EMPLOYEES BY JOB TITLE THAT ARE ABOUT TO RETIRE
SELECT 
COUNT(EMP_NO) AS COUNT 
,TITLE
INTO EMP_COUNT_BY_TITLE
FROM MOST_RECENT_TITLE 
GROUP BY TITLE
ORDER BY COUNT DESC
;


-- DELIVERABLE 2

-- WRITE A QUERY TO CREATE A MENTORSHIP ELIGIBILITY TABLE
SELECT DISTINCT ON (E.EMP_NO)
E.EMP_NO
,E.FIRST_NAME
,E.LAST_NAME
,E.BIRTH_DATE
,DE.FROM_DATE
,DE.TO_DATE
,T.TITLE
INTO MENTORSHIP_ELIGIBLE 
FROM EMPLOYEES AS E
INNER JOIN DEPT_EMP AS DE ON (E.EMP_NO = DE.EMP_NO)
INNER JOIN TITLES AS T ON (E.EMP_NO = T.EMP_NO)
-- FILTERING ON THE TITLE FIELD FROM THE TITLES TABLE INSTEAD OF THE DEPT_EMP TO FIND ACTIVE EMPLOYEES 
-- AND THEIR MOST RECENT TITLE. FILTERING ON THE DEPT_EMP EMPLOYEE FIELD WILL NOT GIVE US THEIR CURRENT TITLE IN ALL CASES. 
-- THE IMAGE IN STEP 11 OF THE MODULE IS INCORRECT AND SHOWS PREVIOUS ROLES FOR SOME CURRENT EMPLOYEES. 
WHERE T.TO_DATE = '9999-01-01'
AND E.BIRTH_DATE BETWEEN '1965-01-01' AND '1965-12-31'
ORDER BY EMP_NO
;