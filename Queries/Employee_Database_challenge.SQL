-- DELIVERABLE 1

-- CREATE RETIREMENT_TITLES DATASET 
SELECT 
E.EMP_NO
,E.FIRST_NAME
,E.LAST_NAME
,T.TITLE
,T.FROM_DATE
,T.TO_DATE
INTO retirement_titles
FROM EMPLOYEES AS E
INNER JOIN TITLES T ON (E.EMP_NO = T.EMP_NO)
WHERE E.BIRTH_DATE BETWEEN '1952-01-01' AND '1955-12-31'
ORDER BY EMP_NO
;

SELECT *
FROM retiring_titles;

-- DROP TABLE unique_titles;

-- USE DICTINCT WITH ORDERBY TO REMOVE DUPLICATE ROWS (IF YOU FOLLOW THE MODULE 7 CHALLENGE INSTRUCTIONS WE WILL STILL HAVE EMPLOYEES IN OUR )

-- NOTE: IF YOU ONLY FOLLOW THE MODULE 7 CHALLENGE INSTRUCTIONS WE WILL STILL HAVE EMPLOYEES IN OUR... 
-- DATASET THAT HAVE ALREADY RETIRED (EMP 10011 FOR INSTANCE) WE NEED TO ADD A FILTER FOR TO_DATE ON THE EMPLOYEE TABLE.))

-- ADDITIONAL NOTE: FILTERING THE TABLE IN THIS STEP BY THE TITLE TABLES TO_DATE COLUMN MAKES THE "DISTINCT ON" STEP IRRELEVANT 
SELECT DISTINCT ON (EMP_NO) 
EMP_NO
,FIRST_NAME
,LAST_NAME
,TITLE
--,TO_DATE
INTO unique_titles
FROM retirement_titles
WHERE TO_DATE = '9999-01-01'
ORDER BY EMP_NO, TO_DATE DESC;

-- GET THE NUMBER OF EMPLOYEES BY JOB TITLE THAT ARE ABOUT TO RETIRE 

-- NOTE: MY RUSULTS ARE DIFFERENT THAN THE TABLE IN THE MODULE... THERE ARE EMPLOYEES THAT PREVIOUSLY LEFT
-- THE COMANY STILL INCLUDED IN THE MODULE RESULTS. 
SELECT 
COUNT(EMP_NO) AS COUNT 
,TITLE
INTO retiring_titles
FROM unique_titles 
GROUP BY TITLE
ORDER BY COUNT DESC
;


-- DELIVERABLE 2

-- WRITE A QUERY TO CREATE A MENTORSHIP ELIGIBILITY TABLE
SELECT DISTINCT ON (E.EMP_NO)
E.EMP_NO
,E.FIRST_NAME
,E.LAST_NAME
,E.BIRTH_DATE
,DE.FROM_DATE
,DE.TO_DATE
,T.TITLE
INTO MENTORSHIP_ELIGIBLE 
FROM EMPLOYEES AS E
INNER JOIN DEPT_EMP AS DE ON (E.EMP_NO = DE.EMP_NO)
INNER JOIN TITLES AS T ON (E.EMP_NO = T.EMP_NO)
-- FILTERING ON THE TITLE FIELD FROM THE TITLES TABLE INSTEAD OF THE DEPT_EMP TO FIND ACTIVE EMPLOYEES 
-- AND THEIR MOST RECENT TITLE. FILTERING ON THE DEPT_EMP EMPLOYEE FIELD WILL NOT GIVE US THEIR CURRENT TITLE IN ALL CASES. 
-- THE IMAGE IN STEP 11 OF THE MODULE IS INCORRECT AND SHOWS PREVIOUS ROLES FOR SOME CURRENT EMPLOYEES. 
WHERE T.TO_DATE = '9999-01-01'
AND E.BIRTH_DATE BETWEEN '1965-01-01' AND '1965-12-31'
ORDER BY EMP_NO
;



-- ADDITIONAL VIEWS USED FOR THE ANALYSIS PORTION OF THE PROJECT

SELECT 
COUNT(EMP_NO)
,TITLE
FROM MENTORSHIP_ELIGIBLE
GROUP BY TITLE
ORDER BY COUNT DESC;

SELECT 
COUNT(EMP_NO)
FROM UNIQUE_TITLES;

SELECT 
COUNT(DE.EMP_NO) AS ACTIVE_EMPLOYEES
,COUNT(UT.EMP_NO) AS RETIREMENT_EMPLOYEES
FROM DEPT_EMP AS DE
LEFT JOIN UNIQUE_TITLES AS UT ON (DE.EMP_NO = UT.EMP_NO)
WHERE DE.TO_DATE = '9999-01-01'